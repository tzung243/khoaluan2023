\chapter{ Hyperledger Fabric}
\section{Giới thiệu Hyperledger Fabric }
Hyperledger Fabric là một nền tảng blockchain phân tán được phát triển bởi Linux. Nó 
cung cấp một giải pháp cho các tổ chức và doanh nghiệp để triển khai các ứng dụng blockchain 
tùy chỉnh. Hyperledger Fabric được thiết kế để có tính linh hoạt và khả năng mở rộng dễ dàng, 
cho phép các thành phần của hệ thống phát triển và triển khai độc lập với nhau.

Hyperledger Fabric có tính bảo mật cao và hỗ trợ quản lý danh tính và quản lý quyền truy cập, 
giúp bảo vệ dữ liệu của người dùng trên blockchain. Nó bao gồm các hợp đồng thông minh, sổ cái và
hệ thống mà người tham gia vào hệ thống quản lý các giao dịch của họ.


Điểm khác biệt giữa Hyperledger Fabric và các nền tảng blockchain khác là:
\begin{itemize}
    \item[-] Thiết kế dựa trên mô hình module 
    \item[-] Hỗ trợ quản lý danh tính và quyền truy cập
    \item[-] Độc lập với tiền tiện tử
    \item[-] Hỗ trợ các giao thức đồng thuận kết hợp
\end{itemize}

Fabric có kiến trúc linh hoạt, có thể thay đổi để đáp ứng cho nhiều lĩnh vực khác nhau, 
điều này chính là lý do em chọn Hyperledger Fabric để nghiên cứu và xây dựng ứng dụng.
\subsection{Mô hình mô-đun}

Hyperledger Fabric được thiết kế dựa trên mô hình mô-đun, cho phép các thành phần của hệ 
thống được phát triển và triển khai độc lập với nhau. Điều này giúp cho việc phát triển và 
triển khai các ứng dụng blockchain trở nên dễ dàng hơn.
Một Fabric tiêu chuẩn gồm các thành phần mô-đun sau:
\begin{itemize}
    \item[-] \textit{Dịch vụ đặt hàng (Ordering service)} được sử dụng để quản lý và xác nhận các giao dịch 
    trên mạng blockchain.
    
    \item[-] \textit{Dịch vụ cung cấp thành viên (Membership service provider)} là một thành phần trong hệ thống Hyperledger Fabric, 
    được sử dụng để quản lý và xác thực danh tính trên mạng blockchain. Nó đảm bảo rằng chỉ 
    các thành viên được ủy quyền mới có thể tham gia vào mạng blockchain và thực hiện các 
    hoạt động trên đó. MSP sử dụng các chứng chỉ xác thực để xác định quyền truy cập của mỗi thành viên trong mạng.
    \item[-] \textit{Dịch vụ nhắn tin ngang hàng (Cross-chain messaging service)} được sử dụng để cho phép các thành viên có thể 
    tương tác và giao tiếp với nhau trực tiếp, mà không cần thông qua một bên trung gian nào khác.
    \item[-] \textit{Hợp đồng thông minh (Chaincode)} chạy trong môi trường container như Docker. 
    Được viết bằng các ngôn ngữ lập trình để quy định các luật và điều khoản khi tham gia vào hệ thống. 
    \item[-] \textit{Sổ cái} nơi lưu trữ tất cả các thông tin về các giao dịch và trạng thái của mạng blockchain, 
    được hỗ trợ bởi nhiều hệ quản trị cơ sở dữ liệu.
    \item[-] \textit{Chính sách xác thực và chứng thực} có thể được thêm và áp dụng độc lập cho mỗi ứng dụng.
   
\end{itemize}

\subsection{Quản lý danh tính và quyền truy cập}

Hyperledger Fabric có tính năng hỗ trợ quản lý danh tính và quyền truy cập để đảm bảo 
tính bảo mật và phân quyền trong mạng blockchain. Dưới đây là một số tính năng quan trọng 
trong việc quản lý danh tính và quyền truy cập trong Hyperledger Fabric:

\begin{itemize}
    \item[-] Xác thực và ủy quyền: hỗ trợ nhiều phương thức xác thực và ủy quyền khác nhau, 
    chẳng hạn như xác thực bằng chứng chỉ SSL/TLS, xác thực bằng tài khoản và mật khẩu, 
    xác thực bằng access token và ủy quyền bằng các chứng chỉ.
    \item[-] Quản lý danh tính: cung cấp tính năng quản lý danh tính để quản lý các thông tin
    về người dùng và tổ chức trên mạng blockchain.
    \item[-] Quản lý quyền truy cập: cung cấp tính năng quản lý quyền truy cập để quản lý 
    người dùng đảm bảo rằng với mỗi người dùng có nhiệm vụ khác nhau thì quyền truy cập trong
    hệ thống là khác nhau.
    \item[-] Quản lý chứng chỉ: cung cấp tính năng quản lý chứng chỉ để quản lý các chứng chỉ
    và chứng thư số, để bảo mật và xác thực người dùng. 

\end{itemize}
\subsection{Độc lập với tiền tiện tử}

Hyperledger Fabric là một nền tảng blockchain phổ biến được thiết kế để sử dụng trong các 
ứng dụng doanh nghiệp. Khác với các tiền điện tử như Bitcoin hay Ethereum, Hyperledger 
Fabric không phải là một loại tiền điện tử và không thực hiện các giao dịch tiền tệ. Thay 
vào đó, nó cung cấp các tính năng để đảm bảo tính toàn vẹn và bảo mật của dữ liệu trong 
mạng blockchain, giúp các doanh nghiệp triển khai các ứng dụng blockchain phù hợp với nhu 
cầu của họ.

Cụ thể hơn, trong Bitcoin hay Etherem, khi miner giải bài toán khó PoW để xác minh tính
toàn vẹn của thông tin sẽ được một phần thưởng là một lượng tiền điện tử. Thay vào đó, Hyperledger Fabric
sử dụng một hệ thống đồng thuận phân cấp để đảm bảo tính toàn vẹn và bảo mật của dữ liệu 
trên mạng blockchain. Các thành viên trong mạng Hyperledger Fabric được xác định và quản 
lý bởi các chứng chỉ xác thực và quy tắc thành viên. Khi một giao dịch mới được đề xuất, 
các thành viên trong mạng sẽ thẩm định và chấp nhận nó trước khi thêm vào blockchain.

\subsection{Cơ chế đồng thuận kết hợp}
Hyperledger Fabric là một nền tảng blockchain dành cho doanh nghiệp, có khả năng hỗ trợ 
nhiều cơ chế đồng thuận khác nhau như Proof of Work (PoW), Practical Byzantine Fault 
Tolerance (PBFT) và Kafka Ordering Service. Việc sử dụng cơ chế đồng thuận kết hợp trong 
Hyperledger Fabric được thực hiện nhằm đảm bảo tính toàn vẹn và bảo mật của hệ thống. 

PBFT được sử dụng để đồng thuận giữa các thành viên trong mạng, đảm bảo rằng các giao dịch 
được xác nhận và thêm vào blockchain chỉ khi được chấp thuận bởi đa số các thành viên trong mạng. 
Bên cạnh đó, Kafka Ordering Service được sử dụng để quản lý thứ tự của các block mới được 
thêm vào blockchain, tránh xảy ra các xung đột về thứ tự của các block. 

Ngoài ra, Hyperledger Fabric cũng có thể sử dụng các cơ chế đồng thuận khác như PoW hoặc PoS 
tùy thuộc vào yêu cầu của từng ứng dụng blockchain cụ thể. 

Trình bày cụ thể về các cơ chế đồng thuận kết hợp trong Hyperledger Fabric, em sẽ trình bày 
ở phần \textbf{Cơ chế đồng thuận}.
\section{Mô hình Hyperledger Fabric}
\subsection{Thành phần hệ thống}
\subsubsection{Nút}
Các nút trong hệ thống này đảm nhận các vai trò khác nhau. Mỗi loại nút có quyền truy cập và vai trò khác
nhau trong hệ thống.
Có 3 vai trò nút trong hệ thống:  
\begin{itemize}
    \item[-] Khách (Client): như là người dùng cuối, nó tạo và huỷ 
    các giao dịch, cho phép đảm nhận vai trò giao tiếp với các nút khác trong mạng.
    \item[-] Thành viên (Peer): Là nút mạng tham gia vào quá trình xử lý giao dịch và lưu trữ 
    dữ liệu trong mạng blockchain. Mỗi nút thành viên có một bản sao của sổ cái và có 
    thể thực hiện các chức năng như giao tiếp với các nút khác, đảm nhận xác thực và xử lý 
    giao dịch, thực hiện các chaincode (smart contract), cập nhật trạng thái của 
    sổ cái, và đồng bộ dữ liệu với các nút thành viên khác.
    
    Có hai loại nút thành viên khác nhau: người chứng thực (Endorsers) và người cam kết (Committers).
        \begin{itemize}
            \item[+] Người chứng thực: Mô phỏng, thực thi logic kinh doanh trong chaincode và xác minh tính hợp lệ giao dịch.
            \item[+] Người cam kết: Xác minh và xác nhận kết quả giao dịch trước khi thêm giao dịch vào blockchain.
        \end{itemize}
    \item[-] Người đặt hàng (Orderer): vai trò là kênh liên lạc trung tâm cho mạng lưới, 
    đảm bảo các thành viên sẽ nhận chính 
    xác một thông điệp theo đúng logic và quản lý thứ tự của các 
    khối mới được thêm vào blockchain.
    
\end{itemize}
\subsubsection{Tài sản}
Tài sản là các đối tượng có giá trị được quản lý trên mạng blockchain trong 
Hyperledger Fabric. Mỗi tài sản có một ID duy nhất và được lưu trữ trong world state 
ledger. Trạng thái của mỗi tài sản được đại diện bởi cơ sở dữ liệu key-value và 
được cập nhật thông qua chaincode để tạo mới, cập nhật, xóa và truy vấn thông tin.
Các hoạt động này được thực hiện thông qua các giao dịch trên một Kênh.
\subsubsection{Chaincode}

Trong Hyperledger Fabric, hợp đồng thông minh được gọi là chaincode. Chaincode là 
một phần mềm các định một hoặc nhiều nội dung. Nó thực thi các quy tắc được xác định
để đọc và thay đổi các cặp giá trị key-value được lưu trữ trong sổ cái. 

Một giao dịch đề xuất thay đổi được gửi đến các nút thành viên trong mạng blockchain, và các 
thành viên thực thi chaincode để kiểm tra và xác minh giao dịch này. Nếu giao dịch thoả mãn các quy 
tắc được định nghĩa bởi chaincode, giao dịch sẽ được thực thi và kết 
quả được thêm cho sổ cái được lưu tất cả các nút thành viên.

\subsubsection{Sổ cái}
Mỗi sổ cái là một bản sao của toàn bộ blockchain và được lưu trữ trên mỗi nút thành viên trong mạng.
Hệ thống có thể lưu trữ nhiều sổ cái khác nhau, mỗi sổ cái được lưu trữ trên một channel riêng biệt. 
Trong Hyperledger Fabric, một sổ cái bao gồm 2 phần:

\begin{itemize}
    \item[-] World state ledger: Lưu trữ trạng thái hiện tại của tất cả các 
    tài sản trong mạng blockchain. World state ledger được lưu trữ dưới dạng cơ sở dữ liệu key-value, trong đó khóa là ID của tài sản và giá trị là trạng thái hiện tại của tài sản đó.
    \item[-] Transaction log ledger: Lưu trữ toàn bộ lịch sử các giao dịch được thực hiện 
    trên mạng blockchain. Transaction log ledger bao gồm các khối được kết nối theo đúng 
    thứ tự thời gian, mỗi khối chứa thông tin về các giao dịch được thực hiện trong khoảng 
    thời gian đó. Khác với World state ledger chỉ lưu trữ giá trị hiện tại, transaction log ledger
    lưu trữ toàn bộ lịch sử các giao dịch dưới dạng chuỗi các khối. Đây là
    một khối bất biến, không thể sửa đổi.
\end{itemize}
\subsubsection{Dịch vụ đặt hàng}
Nút đặt hàng thực hiện việc đặt hàng giao dịch, nút này 
cùng với các nút đặt hàng khác tạo thành một dịch vụ đặt hàng.
Dịch vụ đặt hàng cung cấp một kênh truyền thông cho 
các nút trong mạng để phát sóng các tin nhắn chứa các giao 
dịch, đồng bộ hoá các giao dịch và đảm bảo tính nhất quán 
của trạng thái blockchain.
Nút đặt hàng cũng thực thi kiểm soát truy cập cơ bản đối với 
các kênh, hạn chế người có thể đọc và ghi dữ liệu vào chúng 
cũng như ai có thể định cấu hình chúng.

Khi khách hàng yêu cầu thêm một giao dịch trên blockchain, 
nó được đưa vào một gói tin và phát sóng đến Dịch vụ đặt 
hàng. Dịch vụ đặt hàng sẽ đảm bảo rằng các giao dịch được 
xử lý và đóng gói thành các khối theo một thứ tự nhất định 
và phát sóng đến tất cả các nút trong mạng. Các nút sau đó 
sẽ xác nhận và thêm khối này vào trạng thái blockchain của 
mình nếu khối đấy thoả mãn.

Trong dịch vụ đặt hàng sử dụng cơ chế đồng thuận Kafka Orderering Service (Kafka) để khi một 
khối mới được tạo ra bởi Kafka-based Ordering Service, nó sẽ được phát sóng đến tất cả các nút trong mạng. Các nút trong mạng sau đó sẽ xác nhận và kiểm tra tính hợp lệ của các giao dịch trong khối mới này.


\subsubsection{Kênh}

Trong hệ thống Hyperledger Fabric, kêng là một tính năng quan trọng để cung cấp cách thức 
truyền tải thông tin và giao tiếp bảo mật giữa các thành viên trong mạng blockchain.

Mỗi kênh là một nơi truyền thông riêng biệt giữa một nhóm các thành viên trong mạng, 
cho phép các thành viên trong kênh đóng vai trò như các bên liên quan duy nhất đến các giao 
dịch và trạng thái của sổ cái liên quan đến kênh đó. Điều này có nghĩa là nếu một thành 
viên không thuộc kênh không có quyền truy cập vào các giao dịch và trạng thái của kênh đó.

Mỗi kênh có một sổ cái riêng, bao gồm một World State Ledger và một Transaction Log Ledger, 
để lưu trữ thông tin về trạng thái hiện tại của tài sản trong sổ cái và lịch sử các giao dịch liên quan đến 
sổ cái đó. Khi một giao dịch được thực hiện trên một kênh, nó sẽ chỉ ảnh hưởng đến sổ cái 
của kênh đó và không ảnh hưởng đến các kênh khác.

Một thành viên có thể tham gia cùng lúc nhiều kênh và lưu trữ tất cả các sổ cái của các kênh.

\subsection{Cơ chế đồng thuận}

% Trong Hyperledger Fabric, một giao dịch được xem là hợp lệ nếu nó đi qua 3 bước:

% \begin{itemize}
%     \item Chứng thực giao dịch
%     \item Đặt hàng
%     \item Xác nhận và cam kết
% \end{itemize}

% Cơ chế đồng thuận là việc kết hợp ba bước trên để tạo ra một kết quả cuối cùng
% là thêm hoặc không thêm khối chứa các giao dịch vào blockchain.

% Cơ chế đồng thuận phủ khắp và bao gồm toàn bộ quá trình giao dịch. Các nút 
% có nhiệm vụ khác nhau sẽ có vai trò khác nhau trong quá trình đồng thuận.

% Hyperledger Fabric sử dụng chủ yếu 2 cơ chế đồng thuận là Kafka và PBFT.

% PBFT (Practical Byzantine Lỗi Sức chịu đựng) có thể cung cấp cơ chế để các bản sao tệp giao tiếp với nhau nhằm giữ cho mỗi bản sao nhất quán, ngay cả trong trường hợp bị hỏng. 
% PBFT là một thuật toán không phân nhánh dựa trên người lãnh đạo. Nó yêu cầu tất cả các nút phải được kết nối với tất cả các nút khác. Tất cả các nút đều được biết và thuật toán không cho phép các nút ngẫu nhiên tham gia nhóm ngang hàng. Thuật toán hỗ trợ tới một phần ba số nút bị lỗi. Miễn là không quá một phần ba số nút bị lỗi, thì có thể đạt được sự đồng thuận.
\subsection{Luồng giao dịch}

Luồng giao dịch có các bước sau:
\begin{figure}[h]
    \centering
    \includegraphics[width=1\textwidth]{images/flow-4.png}
    \caption{Luồng giao dịch }
\end{figure}


\begin{itemize}
    \item[\textbf{1.}] Khách gửi một giao dịch đến các  nút chứng thực. Nút chứng thực được sử dụng để chứng nhận tính hợp 
    lệ của một giao dịch trước khi nó được gửi đến các nút khác để xác nhận và cam kết trên 
    sổ cái. Nó không lưu trữ trực tiếp các thông tin liên quan đến giao dịch hoặc sổ cái.
    \item[\textbf{2.}] Khi một giao dịch được gửi đến nút chứng thực, nó sẽ thực hiện một số hoạt 
    động để chứng nhận tính hợp lệ của giao dịch đó. Đầu tiên, nó sẽ kiểm 
    tra xác thực của người gửi giao dịch và xác định xem họ có quyền thực hiện giao dịch hay 
    không. Sau đó, nó sẽ thực hiện việc thực thi các hàm chaincode để xác 
    định xem giao dịch có hợp lệ hay không. Với mỗi một lệnh được thực hiện thì ta ghi lại 
    trạng thái đọc và ghi của dữ liệu,gọi là tập ReadWrite (RW)
    Nếu nút này thấy là giao dịch hợp lệ, nó sẽ tạo một chữ ký bảo lãnh và gửi lại cho người 
    gửi giao dịch. 
    \item[\textbf{3.}] Khi một giao dịch được chứng nhận hợp lệ, khách sẽ gửi giao dịch
    đó đến các ordering service. Người đặt hàng sẽ xác định thứ tự của các khối dựa trên 
    chữ ký bảo lãnh của nút chứng thực và sắp xếp các giao dịch vào các khối tương 
    ứng. Sau đó nó gửi các khối đến toàn bộ nút thành viên.
    \item[\textbf{4.}] Người cam kết sẽ xác nhận lại các chính sách xác thực một lần nữa. 
    Đồng thời nó kiểm tra hiệu lực của tập RW. Việc xác nhận giao dịch sẽ được lưu vào World- state, còn sổ cái sẽ lưu lại các giao dịch. 
    Khi này, sổ cái được đồng bộ hóa.
    \item[\textbf{4.} Người cam kết sẽ thông báo lại cho ứng dụng là trạng thái của giao dịch. 
    Ứng dụng sẽ được thông báo bởi các thành viên trong kênh.]
\end{itemize}

\section{Mạng Blockchain Hyperledge Fabric}